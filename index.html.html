<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Michi - Generador de Paletas IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes loading {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-loading {
            animation: loading 2s ease-in-out forwards;
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-in;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-white">
    <!-- Pantalla de carga -->
    <div id="loadingScreen" class="min-h-screen flex items-center justify-center">
        <div class="transition-all duration-500" id="logoContainer">
            <svg viewBox="0 0 240 240" class="w-32 h-32 mx-auto mb-6">
                <circle cx="120" cy="120" r="100" fill="black"/>
                <circle cx="120" cy="120" r="85" fill="white"/>
                <path d="M 120 75 Q 95 75 85 95 Q 80 105 80 115 Q 80 120 82 122 L 88 125 Q 95 130 105 132 Q 112 133 120 133 Q 128 133 135 132 Q 145 130 152 125 L 158 122 Q 160 120 160 115 Q 160 105 155 95 Q 145 75 120 75 Z" fill="black"/>
                <path d="M 88 85 L 80 65 L 95 80 Z" fill="black"/>
                <path d="M 152 85 L 160 65 L 145 80 Z" fill="black"/>
                <ellipse cx="120" cy="165" rx="28" ry="32" fill="black"/>
            </svg>
            <h1 class="text-6xl font-light text-black text-center tracking-tight">Michi</h1>
            <div class="w-48 h-0.5 bg-gray-200 mx-auto mt-8 overflow-hidden">
                <div class="h-full bg-black animate-loading"></div>
            </div>
        </div>
    </div>

    <!-- Aplicación principal -->
    <div id="mainApp" class="hidden min-h-screen">
        <div class="max-w-4xl mx-auto px-6 py-12">
            <!-- Header -->
            <div class="text-center mb-16">
                <svg viewBox="0 0 240 240" class="w-20 h-20 mx-auto mb-6">
                    <circle cx="120" cy="120" r="100" fill="black"/>
                    <circle cx="120" cy="120" r="85" fill="white"/>
                    <path d="M 120 75 Q 95 75 85 95 Q 80 105 80 115 Q 80 120 82 122 L 88 125 Q 95 130 105 132 Q 112 133 120 133 Q 128 133 135 132 Q 145 130 152 125 L 158 122 Q 160 120 160 115 Q 160 105 155 95 Q 145 75 120 75 Z" fill="black"/>
                    <path d="M 88 85 L 80 65 L 95 80 Z" fill="black"/>
                    <path d="M 152 85 L 160 65 L 145 80 Z" fill="black"/>
                    <ellipse cx="120" cy="165" rx="28" ry="32" fill="black"/>
                </svg>
                <h1 class="text-5xl font-light text-black mb-3 tracking-tight">Michi</h1>
                <p class="text-gray-500 text-sm">Generador de paletas con IA</p>
            </div>

            <!-- Input Section -->
            <div class="mb-12">
                <div class="flex gap-2 mb-3">
                    <input
                        type="text"
                        id="promptInput"
                        placeholder="Describe tu paleta..."
                        class="flex-1 px-4 py-3 border border-gray-300 focus:outline-none focus:border-black text-sm"
                    />
                    <button
                        id="generateBtn"
                        class="px-8 py-3 bg-black text-white text-sm hover:bg-gray-800 transition-colors"
                    >
                        Generar
                    </button>
                </div>

                <!-- Example prompts -->
                <div class="flex gap-2 text-xs flex-wrap">
                    <button class="example-btn text-gray-400 hover:text-black transition-colors">Atardecer tropical</button>
                    <button class="example-btn text-gray-400 hover:text-black transition-colors">Café en otoño</button>
                    <button class="example-btn text-gray-400 hover:text-black transition-colors">Neón futurista</button>
                    <button class="example-btn text-gray-400 hover:text-black transition-colors">Bosque mágico</button>
                    <button class="example-btn text-gray-400 hover:text-black transition-colors">Océano profundo</button>
                    <button class="example-btn text-gray-400 hover:text-black transition-colors">Desierto cálido</button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="hidden flex items-center justify-center py-20">
                <svg class="animate-spin w-8 h-8 text-gray-400" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>

            <!-- Palettes Container -->
            <div id="palettesContainer" class="space-y-8"></div>

            <!-- Empty state -->
            <div id="emptyState" class="text-center py-20 border border-gray-200">
                <p class="text-gray-400 text-sm">Describe un concepto para generar paletas</p>
            </div>
        </div>
    </div>

    <script>
        // --- Estado y elementos ---
        let isGenerating = false; // flag para evitar ejecuciones concurrentes
        const promptInput = document.getElementById('promptInput');
        const generateBtn = document.getElementById('generateBtn');
        const loadingState = document.getElementById('loadingState');
        const palettesContainer = document.getElementById('palettesContainer');
        const emptyState = document.getElementById('emptyState');
        const exampleBtns = document.querySelectorAll('.example-btn');

        // Animación de carga inicial
        setTimeout(() => {
            const logo = document.getElementById('logoContainer');
            if (logo) {
                logo.style.opacity = '0';
                logo.style.transform = 'scale(0.95)';
            }
            setTimeout(() => {
                const ls = document.getElementById('loadingScreen');
                if (ls) ls.style.display = 'none';
                const app = document.getElementById('mainApp');
                if (app) {
                    app.classList.remove('hidden');
                    app.classList.add('animate-fadeIn');
                }
            }, 500);
        }, 2000);

        // Event listeners para ejemplos
        exampleBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                promptInput.value = btn.textContent;
            });
        });

        // Evitar múltiples envíos rápidos
        function safeStartGenerating() {
            if (isGenerating) return false;
            isGenerating = true;
            return true;
        }
        function safeStopGenerating() {
            isGenerating = false;
        }

        // Gestionar generación (debounced/guarded)
        generateBtn.addEventListener('click', () => {
            if (!safeStartGenerating()) return;
            generatePalettes();
        });
        promptInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (!safeStartGenerating()) return;
                generatePalettes();
            }
        });

        // --- Utilidades ---
        // Escritura segura al clipboard con fallback
        async function safeWriteClipboard(text) {
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                    return true;
                }
            } catch (err) {
                console.warn('navigator.clipboard failed:', err);
            }
            // Fallback: textarea temporal
            try {
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                return true;
            } catch (err) {
                console.warn('fallback clipboard failed:', err);
                return false;
            }
        }

        // Función para convertir HSL a HEX
        function hslToHex(h, s, l) {
            l /= 100;
            const a = s * Math.min(l, 1 - l) / 100;
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`;
        }

        // --- Generación de paletas ---
        async function generatePalettes() {
            // Desactivar controles
            generateBtn.disabled = true;
            promptInput.disabled = true;
            loadingState.classList.remove('hidden');
            emptyState.style.display = 'none';
            palettesContainer.innerHTML = '';

            try {
                const prompt = promptInput.value.trim().toLowerCase();
                if (!prompt) {
                    // nada que generar
                    return;
                }

                // Simular procesamiento (o sustituir por llamada API si quieres)
                const palettes = await new Promise((resolve) => {
                    setTimeout(() => {
                        resolve(createPalettesFromPrompt(prompt));
                    }, 600);
                });

                displayPalettes(palettes);
            } catch (err) {
                console.error('Error generando paletas:', err);
                alert('Error al generar paletas. Revisa la consola para más detalles.');
            } finally {
                // Rehabilitar controles
                loadingState.classList.add('hidden');
                generateBtn.disabled = false;
                promptInput.disabled = false;
                safeStopGenerating();
            }
        }

        // Crear paletas basadas en palabras clave (sin modificaciones significativas)
        function createPalettesFromPrompt(prompt) {
            const keywords = {
                'bosque': { base: 120, sat: 45, names: ['Bosque Encantado', 'Verde Natural', 'Selva Mística'] },
                'océano': { base: 200, sat: 60, names: ['Océano Profundo', 'Azul Marina', 'Olas del Mar'] },
                'desierto': { base: 35, sat: 70, names: ['Desierto Cálido', 'Arena Dorada', 'Sahara'] },
                'atardecer': { base: 15, sat: 80, names: ['Atardecer Tropical', 'Cielo de Fuego', 'Ocaso Vibrante'] },
                'primavera': { base: 75, sat: 55, names: ['Primavera Fresca', 'Jardín Florido', 'Brotes Nuevos'] },
                'alegre': { base: 50, sat: 75, names: ['Alegría Vibrante', 'Energía Positiva', 'Felicidad Pura'] },
                'tranquilo': { base: 190, sat: 35, names: ['Calma Serena', 'Paz Interior', 'Tranquilidad'] },
                'elegante': { base: 280, sat: 25, names: ['Elegancia Sofisticada', 'Lujo Discreto', 'Refinamiento'] },
                'enérgico': { base: 0, sat: 85, names: ['Energía Explosiva', 'Poder Dinámico', 'Fuerza Vital'] },
                'café': { base: 25, sat: 45, names: ['Café Acogedor', 'Aroma de Mañana', 'Espresso Bar'] },
                'neón': { base: 300, sat: 90, names: ['Neón Futurista', 'Cyberpunk', 'Ciudad Nocturna'] },
                'minimalista': { base: 0, sat: 5, names: ['Minimalismo Puro', 'Simplicidad', 'Zen Moderno'] },
                'tropical': { base: 165, sat: 70, names: ['Trópico Vibrante', 'Paraíso Caribeño', 'Isla Exótica'] },
                'verano': { base: 45, sat: 75, names: ['Verano Radiante', 'Sol Brillante', 'Calor Intenso'] },
                'otoño': { base: 30, sat: 60, names: ['Otoño Cálido', 'Hojas Caídas', 'Cosecha'] },
                'invierno': { base: 210, sat: 20, names: ['Invierno Fr\u0000o', 'Hielo Cristalino', 'Nieve Pura'] },
                'vintage': { base: 40, sat: 40, names: ['Vintage Retro', 'Nostalgia', '\u0000poca Dorada'] },
                'pastel': { base: 320, sat: 30, names: ['Pastel Suave', 'Dulzura', 'Nube Rosada'] },
                'oscuro': { base: 240, sat: 15, names: ['Oscuridad Profunda', 'Noche Misteriosa', 'Sombras'] },
            };

            let config = { base: 180, sat: 50, names: ['Paleta \u0000nica', 'Colores Armoniosos', 'Combinaci\u0000n Especial'] };
            for (const [key, value] of Object.entries(keywords)) {
                if (prompt.includes(key)) {
                    config = value;
                    break;
                }
            }

            return [
                generatePalette(config.names[0], config.base, config.sat, 'analogous', getDescription(config.names[0])),
                generatePalette(config.names[1], (config.base + 30) % 360, Math.max(0, config.sat - 10), 'complementary', getDescription(config.names[1])),
                generatePalette(config.names[2], (config.base + 340) % 360, Math.min(100, config.sat + 15), 'triadic', getDescription(config.names[2]))
            ];
        }

        function getDescription(name) {
            const descriptions = {
                'Bosque Encantado': 'Tonos verdes profundos que evocan la serenidad de un bosque m\u0000gico',
                'Verde Natural': 'Paleta terrosa con toques de naturaleza fresca y vibrante',
                'Selva M\u0000stica': 'Verdes intensos mezclados con toques de tierra y vida',
                'Oc\u0000ano Profundo': 'Azules marinos que capturan la esencia del mar',
                'Azul Marina': 'Tonalidades acu\u0000ticas tranquilas y refrescantes',
                'Olas del Mar': 'Del azul claro al profundo, como las capas del oc\u0000ano',
                'Desierto C\u0000alido': 'Naranjas y amarillos que transmiten el calor del desierto',
                'Arena Dorada': 'Tonos c\u0000alidos inspirados en dunas infinitas',
                'Sahara': 'Paleta terrosa con intensidad del sol del desierto',
                'Atardecer Tropical': 'Rojos, naranjas y rosas del cielo al caer el sol',
                'Cielo de Fuego': 'Colores intensos de un atardecer dram\u0000tico',
                'Ocaso Vibrante': 'Del naranja brillante al p\u0000rpura profundo',
                'Primavera Fresca': 'Verdes claros y amarillos como brotes nuevos',
                'Jard\u0000n Florido': 'Paleta fresca con vida y crecimiento',
                'Brotes Nuevos': 'Tonos jóvenes y llenos de energía primaveral',
                'Alegría Vibrante': 'Colores brillantes que irradian felicidad',
                'Energía Positiva': 'Amarillos y naranjas llenos de optimismo',
                'Felicidad Pura': 'Paleta radiante que eleva el ánimo',
                'Calma Serena': 'Azules suaves que transmiten paz absoluta',
                'Paz Interior': 'Tonos relajantes para momentos de tranquilidad',
                'Tranquilidad': 'Colores que invitan a la meditación y descanso',
                'Elegancia Sofisticada': 'Púrpuras y grises refinados y distinguidos',
                'Lujo Discreto': 'Tonos nobles que exudan clase',
                'Refinamiento': 'Paleta elegante para espacios premium',
                'Energía Explosiva': 'Rojos intensos llenos de fuerza vital',
                'Poder Dinámico': 'Colores que transmiten movimiento y acción',
                'Fuerza Vital': 'Paleta cargada de energía pura',
                'Café Acogedor': 'Marrones cálidos que recuerdan a un café íntimo',
                'Aroma de Mañana': 'Tonos tierra con calidez de primera hora',
                'Espresso Bar': 'Del café oscuro a tonos cremosos',
                'Neón Futurista': 'Colores vibrantes de una ciudad cyberpunk',
                'Cyberpunk': 'Magentas y cianes brillantes de un futuro distópico',
                'Ciudad Nocturna': 'Luces artificiales en la oscuridad urbana',
                'Minimalismo Puro': 'Grises y blancos en perfecta armonía simple',
                'Simplicidad': 'Lo esencial en tonos neutros',
                'Zen Moderno': 'Paleta minimalista que inspira claridad',
                'Trópico Vibrante': 'Verdes y azules de un paraíso tropical',
                'Paraíso Caribeño': 'Colores de playas y aguas cristalinas',
                'Isla Exótica': 'Paleta fresca y vibrante de destino soñado',
                'Verano Radiante': 'Amarillos y naranjas del sol de verano',
                'Sol Brillante': 'Tonos cálidos que irradian luz solar',
                'Calor Intenso': 'Colores que transmiten temperatura elevada',
                'Otoño Cálido': 'Naranjas, rojos y marrones de hojas caídas',
                'Hojas Caídas': 'Paleta acogedora de la estación de cosecha',
                'Cosecha': 'Tonos tierra ricos y abundantes',
                'Invierno Fr\u0000o': 'Azules gélidos y grises de días helados',
                'Hielo Cristalino': 'Paleta fría y cristalina como nieve',
                'Nieve Pura': 'Blancos y azules del paisaje invernal',
                'Vintage Retro': 'Tonos nostálgicos de épocas pasadas',
                'Nostalgia': 'Colores desaturados con carácter vintage',
                'Época Dorada': 'Paleta cálida de tiempos memorables',
                'Pastel Suave': 'Rosas y lilas delicados y dulces',
                'Dulzura': 'Tonos suaves como algodón de azúcar',
                'Nube Rosada': 'Paleta etérea y romántica',
                'Oscuridad Profunda': 'Azules y grises oscuros misteriosos',
                'Noche Misteriosa': 'Tonos profundos llenos de intriga',
                'Sombras': 'Paleta oscura con carácter dramático',
                'Paleta \u0000nica': 'Combinación armoniosa de colores balanceados',
                'Colores Armoniosos': 'Tonos que funcionan perfectamente juntos',
                'Combinaci\u0000n Especial': 'Paleta personalizada según tu concepto'
            };
            return descriptions[name] || 'Paleta generada especialmente para tu concepto';
        }

        function generatePalette(name, baseHue, baseSat, type, description) {
            const colors = [];
            if (type === 'analogous') {
                for (let i = 0; i < 5; i++) {
                    const hue = (baseHue + (i * 15)) % 360;
                    const sat = baseSat + (Math.random() * 20 - 10);
                    const light = 40 + (i * 12);
                    colors.push(hslToHex(hue, Math.max(0, Math.min(100, sat)), Math.max(0, Math.min(100, light))));
                }
            } else if (type === 'complementary') {
                colors.push(hslToHex(baseHue, baseSat, 25));
                colors.push(hslToHex(baseHue, Math.min(100, baseSat + 10), 45));
                colors.push(hslToHex((baseHue + 180) % 360, baseSat, 50));
                colors.push(hslToHex((baseHue + 180) % 360, Math.max(0, baseSat - 15), 65));
                colors.push(hslToHex(baseHue, Math.max(0, baseSat - 20), 75));
            } else {
                colors.push(hslToHex(baseHue, baseSat, 30));
                colors.push(hslToHex((baseHue + 120) % 360, baseSat, 45));
                colors.push(hslToHex((baseHue + 240) % 360, baseSat, 50));
                colors.push(hslToHex(baseHue, Math.max(0, baseSat - 15), 65));
                colors.push(hslToHex((baseHue + 120) % 360, Math.max(0, baseSat - 20), 75));
            }
            return { name, colors, description };
        }

        // --- Render y eventos (event delegation) ---
        function displayPalettes(palettes) {
            palettesContainer.innerHTML = '';
            palettes.forEach((palette) => {
                const colorsHTML = palette.colors.map(color => `
                    <div class="flex-1 relative group cursor-pointer color-bar" style="background-color: ${color}" data-color="${color}">
                        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-black bg-opacity-20">
                            <span class="text-white font-mono text-xs bg-black px-2 py-1">${color}</span>
                        </div>
                    </div>
                `).join('');

                const colorCodesHTML = palette.colors.map(color => `
                    <code class="px-2 py-1 bg-gray-50 text-xs font-mono text-gray-600">${color}</code>
                `).join('');

                const div = document.createElement('div');
                div.className = 'border border-gray-200';
                div.innerHTML = `
                    <div class="flex h-40">${colorsHTML}</div>
                    <div class="p-6 bg-white">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-light text-black mb-1">${palette.name}</h3>
                                <p class="text-gray-500 text-sm">${palette.description}</p>
                            </div>
                            <div class="flex gap-1">
                                <button class="copy-btn p-2 hover:bg-gray-100 transition-colors" data-colors='${JSON.stringify(palette.colors)}' title="Copiar">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                                <button class="download-btn p-2 hover:bg-gray-100 transition-colors" data-palette='${JSON.stringify(palette)}' title="Descargar">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="flex gap-2 flex-wrap">${colorCodesHTML}</div>
                    </div>
                `;
                palettesContainer.appendChild(div);
            });
        }

        // Delegación de eventos en container (más eficiente)
        palettesContainer.addEventListener('click', async (e) => {
            const btnCopy = e.target.closest('.copy-btn');
            if (btnCopy) {
                try {
                    const colors = JSON.parse(btnCopy.getAttribute('data-colors') || '[]');
                    await safeWriteClipboard(colors.join(', '));
                    // feedback visual (cambia temporalmente el icono)
                    const prev = btnCopy.innerHTML;
                    btnCopy.innerHTML = '<svg class="w-4 h-4 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                    setTimeout(() => btnCopy.innerHTML = prev, 1400);
                } catch (err) {
                    console.warn('Error copiando paleta:', err);
                }
                return;
            }

            const btnDownload = e.target.closest('.download-btn');
            if (btnDownload) {
                try {
                    const palette = JSON.parse(btnDownload.getAttribute('data-palette') || '{}');
                    downloadPalette(palette);
                } catch (err) {
                    console.warn('Error descargando paleta:', err);
                }
                return;
            }

            const colorBar = e.target.closest('.color-bar');
            if (colorBar) {
                const color = colorBar.dataset.color;
                safeWriteClipboard(color).catch(() => {});
                return;
            }
        });

        // --- Descargar paleta a PNG ---
        function downloadPalette(palette) {
            try {
                const canvas = document.createElement('canvas');
                canvas.width = 1000;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');

                const colorWidth = canvas.width / (palette.colors?.length || 1);
                (palette.colors || []).forEach((color, i) => {
                    ctx.fillStyle = color;
                    ctx.fillRect(i * colorWidth, 0, colorWidth, canvas.height);
                });

                const dataUrl = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = dataUrl;
                a.download = `${(palette.name || 'palette').replace(/\s+/g, '-').toLowerCase()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch (err) {
                console.warn('Error en downloadPalette:', err);
            }
        }
    </script>
</body>
</html>
